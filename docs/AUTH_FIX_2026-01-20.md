# Authentication Fix - OAuth State Mismatch Issue

**Date**: January 20, 2026  
**Issue**: Users experiencing "Authentication Warning" and automatic logout after successful Cognito login  
**Fix Version**: Committed to `develop` branch (483da1a)  
**Status**: ✅ Fixed - Pending deployment

## Problem Description

Users reported that after successfully logging in via AWS Cognito on both Firefox and Chrome browsers, they would immediately see an "Authentication Warning" and be logged out from https://ui.lab.informationcart.com.

## Root Cause Analysis

Used Playwright to debug the full authentication flow:

```bash
npx playwright test tests/full-auth-debug.spec.ts --config=playwright.config.prod.ts
```

### Errors Captured

```text
[CONSOLE error] Callback error: Error: No matching state found in storage
[CONSOLE error] Callback error: Error: No state in response
```

### Technical Explanation

The issue was in `/src/services/auth.ts`:

**Before (BROKEN)**:

```typescript
const userManagerConfig = {
  // ...
  get userStore() {
    // Lazy initialization to avoid SSR issues
    return new WebStorageStateStore({
      store: typeof window !== 'undefined' ? window.localStorage : ({} as Storage),
    });
  },
  // ...
};
```

**Problem**: The `userStore` getter created a **new** `WebStorageStateStore` instance every time it was accessed. This caused:

1. During login: State parameter stored in Instance A
2. During callback: Looking for state in Instance B (newly created)
3. Result: "No matching state found in storage" error
4. OAuth flow fails → User redirected back to login

## Solution

Created a singleton `WebStorageStateStore` instance:

**After (FIXED)**:

```typescript
// Create singleton WebStorageStateStore to avoid recreating instances
const createStateStore = () => {
  if (typeof window === 'undefined') {
    return undefined; // SSR - let oidc-client-ts use default
  }
  return new WebStorageStateStore({
    store: window.localStorage,
  });
};

const stateStore = createStateStore();

const userManagerConfig = {
  // ...
  userStore: stateStore, // Use singleton instance
  // ...
};
```

## OAuth Flow (After Fix)

1. ✅ User clicks "Sign In"
2. ✅ Redirects to Cognito with state parameter stored in stateStore
3. ✅ User authenticates with Cognito
4. ✅ Callback returns with state parameter
5. ✅ State validated against stateStore (same instance!)
6. ✅ Tokens exchanged and stored
7. ✅ User redirected to dashboard
8. ✅ User stays authenticated

## Testing

### Playwright Test Results

**Before Fix**:

```text
[CONSOLE error] Callback error: Error: No matching state found in storage
User ends up at login page after successful Cognito authentication
```

**After Fix**:

- To be verified after deployment

### Test Command

```bash
cd /home/ubuntu/git/otel-ui
export COGNITO_TEST_USERNAME="testuser@homelab.local"
export COGNITO_TEST_PASSWORD="Homelab@2026!"
npx playwright test tests/full-auth-debug.spec.ts --config=playwright.config.prod.ts
```

## Deployment Steps

1. ✅ Fix committed to `develop` branch
2. ⏳ Merge `develop` to `main`
3. ⏳ GitHub Actions builds new Docker image (stuartshay/otel-ui:1.0.24)
4. ⏳ Update k8s-gitops deployment manifest
5. ⏳ Argo CD syncs to k8s-pi5-cluster
6. ⏳ Test authentication flow on https://ui.lab.informationcart.com

## Related Files

- **Fix**: [/src/services/auth.ts](../src/services/auth.ts)
- **Test**: [/tests/full-auth-debug.spec.ts](../tests/full-auth-debug.spec.ts)
- **Commit**: `483da1a` on `develop` branch

## Related Issues

- Previous CORS issue documented in [AUTH_DEBUG_FINDINGS.md](./AUTH_DEBUG_FINDINGS.md)
- This is a separate issue affecting OAuth state management

## Browser Compatibility

This fix applies to all browsers:

- ✅ Chrome
- ✅ Firefox
- ✅ Safari
- ✅ Edge

The issue was not browser-specific but related to the oidc-client-ts library's state management.

## References

- OAuth 2.0 State Parameter: https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1
- oidc-client-ts Documentation: https://github.com/authts/oidc-client-ts
- WebStorageStateStore: Manages OAuth state in browser localStorage

---

**Impact**: HIGH - Prevents all users from successfully authenticating  
**Severity**: CRITICAL - Users cannot access the application  
**Fix Complexity**: LOW - 13 line change, 1 file modified
